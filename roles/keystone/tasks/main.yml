- name: Create keystone database
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    name: keystone
    state: present
  register: keystonedb_created

- name: Create keystone db user
  community.mysql.mysql_user:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
    name: keystone
    host: "{{ item }}"
    password: "{{ admin_pass }}"
    priv:
      "keystone.*": "ALL,GRANT"
  with_items:
    - localhost
    - "{{ hostvars[groups['controllers'][0]]['ansible_hostname'] }}"
    - "{{ groups['controllers'][0] }}"
  register: keystone_user_grant

- name: Install keystone
  ansible.builtin.apt:
    name: keystone
    state: present
    update_cache: true
  register: keystone_installed

- name: Keystone configuration
  ansible.builtin.template:
    src: keystone.conf.j2
    dest: /etc/keystone/keystone.conf
    mode: 0640
    owner: keystone
    group: keystone
  register: keystone_config
  when: keystone_installed is succeeded

- name: Perform a Keystone DB sync
  ansible.builtin.command: "keystone-manage db_sync"
  become: true
  become_user: keystone
  become_method: su
  become_flags: '-s /bin/sh'
  args:
    creates: /etc/keystone/keystone_db_synced
  register: keystone_bootstrap

- name: Create fernet keys
  ansible.builtin.command: "{{ item }}"
  with_items:
    - "keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone"
    - "keystone-manage credential_setup --keystone-user keystone --keystone-group keystone"
  args:
    creates: /etc/keystone/fernet_keys_created

- name: Bootstrap keyston
  ansible.builtin.command:
    argv:
      - "keystone-manage bootstrap --bootstrap-password {{ admin_password }} "
      - "--bootstrap-admin-url http://controller:5000/v3/"
      - "--bootstrap-internal-url http://controller:5000/v3/"
      - "--bootstrap-public-url http://controller:5000/v3/"
      - "--bootstrap-region-id RegionOne"
    creates: /etc/keystone/keystone_bootstraped
  notify:
    - Restart apache2

- name: Creates openrc file
  ansible.builtin.template:
    src: openrc.j2
    dest: /root/openrc
    mode: 0644
    owner: root
    group: root
